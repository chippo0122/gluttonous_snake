"use strict";var _createClass=function(){function s(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var title=document.querySelector(".title"),body=document.querySelector("body"),control=document.querySelector(".control"),startBtn=document.querySelector(".start-btn"),score=document.querySelector(".score"),scoreBoard=document.querySelector(".score-board"),endPanel=document.querySelector(".end-game-panel"),insertRank=document.getElementById("insertRank"),rankSec=document.querySelector(".ranking-sec"),Vector=function(){function n(e,t){_classCallCheck(this,n),this.x=e||0,this.y=t||0}return _createClass(n,[{key:"add",value:function(e){return new n(this.x+e.x,this.y+e.y)}},{key:"set",value:function(e){this.x=e.x,this.y=e.y}},{key:"equal",value:function(e){return this.x===e.x&&this.y===e.y}},{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"mul",value:function(e){return new n(this.x*e,this.y*e)}}]),n}(),Snake=function(){function e(){_classCallCheck(this,e),this.body=[],this.head=new Vector(17,17),this.maxLength=5,this.speed=new Vector(0,-1),this.direction="Up"}return _createClass(e,[{key:"update",value:function(){this.body.push(this.head);var e=this.head.add(this.speed);for(this.head=e;this.body.length>this.maxLength;)this.body.shift()}},{key:"setDirection",value:function(e){var t=new Vector(0,-1);switch(e){case"Up":t=new Vector(0,-1);break;case"Down":t=new Vector(0,1);break;case"Left":t=new Vector(-1,0);break;case"Right":t=new Vector(1,0)}t.equal(this.speed)||t.equal(this.speed.mul(-1))||(this.speed=t)}},{key:"checkBoundary",value:function(e){var t=0<=this.head.x&&this.head.x<e,e=0<=this.head.y&&this.head.y<e;return t&&e}},{key:"hitSelf",value:function(){for(var e=this.body,t=this.head,n=0;n<e.length;n++)if(e[n].x===t.x&&e[n].y===t.y)return!0;return!1}}]),e}(),Game=function(){function e(){_classCallCheck(this,e),this.blockWidth=13,this.blockGutter=1,this.gameWidth=35,this.speed=30,this.snake=new Snake,this.score=0,this.foods=[],this.bonus=0,this.start=!1,this.rank=JSON.parse(localStorage.getItem("snakeRanking"))||[]}return _createClass(e,[{key:"init",value:function(){var e=this;this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.blockWidth*this.gameWidth+this.blockGutter*(this.gameWidth-1),this.canvas.height=this.canvas.width,this.render(),this.writeRank(),console.log(this.rank),setTimeout(function(){e.update()},300),this.manyFoods(4)}},{key:"startGame",value:function(){this.start=!0,this.snake=new Snake,control.classList.add("hide"),this.update(),this.score=0,this.speed=25,this.bonus=0,this.playSound("C5",-10),this.playSound("C6",-10,200)}},{key:"endGame",value:function(){this.start=!1,scoreBoard.innerText=this.score,endPanel.classList.remove("d-none"),this.playSound("C5",0),this.playSound("C4",0,200)}},{key:"updateRank",value:function(){var e=insertRank.value;if(e.length<=0||5<e.length)return alert("5 characters limit"),0;this.rank.push({name:e,score:this.score}),this.rank.sort(function(e,t){return e.score>t.score?-1:e.score<t.score?1:0}),10<this.rank.length&&this.rank.pop(),localStorage.setItem("snakeRanking",JSON.stringify(this.rank)),this.writeRank(),insertRank.value="",this.closeEndPanel()}},{key:"writeRank",value:function(){for(var e="",t=0;t<this.rank.length;t++)e+='<li class="ranking-item">\n                        <p>'+this.rank[t].name+"</p>\n                        <p>"+this.rank[t].score+"</p>\n                    </li>";rankSec.innerHTML=e}},{key:"closeEndPanel",value:function(){endPanel.classList.add("d-none"),control.classList.remove("hide")}},{key:"render",value:function(){var t=this;this.ctx.fillStyle="rgb(43, 43, 43)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(var e=0;e<this.gameWidth;e++)for(var n=0;n<this.gameWidth;n++)this.drawBlock(new Vector(e,n),"#000");this.snake.body.forEach(function(e){t.drawBlock(e,"#fff")});for(var s=0;s<this.foods.length;s++)this.drawBlock(this.foods[0],"red"),this.drawBlock(this.foods[s],"#05c46b");requestAnimationFrame(function(){t.render()})}},{key:"drawEffect",value:function(e,t){var n=this,s=2,i=this.getPosition(e,t),t=function e(){s++,n.ctx.strokeStyle="#fff",n.ctx.beginPath(),n.ctx.arc(i.x+n.blockWidth/2,i.y+n.blockWidth/2,20*Math.log(s/2),0,2*Math.PI),n.ctx.stroke(),s<100&&requestAnimationFrame(e)};requestAnimationFrame(t)}},{key:"writeScore",value:function(){score.innerText=this.score}},{key:"getPosition",value:function(e,t){return new Vector(this.blockWidth*e+this.blockGutter*(e-1),this.blockWidth*t+this.blockGutter*(t-1))}},{key:"drawBlock",value:function(e,t){this.ctx.fillStyle=t;e=this.getPosition(e.x,e.y);this.ctx.fillRect(e.x,e.y,this.blockWidth,this.blockWidth)}},{key:"update",value:function(){var n=this;this.start&&(this.snake.update(),this.foods.forEach(function(e,t){n.snake.head.equal(e)&&(n.snake.maxLength++,n.foods.splice(t,1),n.generateFoods(),n.score+=10,0===t&&(n.score+=5*n.bonus,n.bonus++))}),!1===this.snake.checkBoundary(this.gameWidth)&&this.endGame(),this.snake.hitSelf()&&this.endGame(),this.writeScore(),this.speed=Math.sqrt(this.snake.body.length)+5+1.25*this.bonus,setTimeout(function(){n.update()},parseInt(1e3/this.speed)))}},{key:"generateFoods",value:function(){var e=Math.floor(Math.random()*this.gameWidth),t=Math.floor(Math.random()*this.gameWidth);this.foods.push(new Vector(e,t)),this.drawEffect(e,t),this.playSound("C5",-20),this.playSound("F6",-20,200)}},{key:"manyFoods",value:function(e){for(var t=0;t<e;t++)this.generateFoods()}},{key:"playSound",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"C4",n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;setTimeout(function(){var e=(new Tone.Synth).toDestination();e.volume.value=n,e.triggerAttackRelease(t,"8n")},arguments[2]||0)}}]),e}(),game=new Game;game.init(),body.addEventListener("keydown",function(e){console.log(endPanel.classList.contains("d-none")),"Enter"===e.key&&endPanel.classList.contains("d-none")&&(document.querySelector(".control").classList.toggle("hide"),game.startGame())}),window.addEventListener("keydown",function(e){game.snake.setDirection(e.key.replace("Arrow",""))});